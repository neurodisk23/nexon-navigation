import numpy as np
from novatel_oem7_msgs.msg import BESTPOS
from novatel_oem7_msgs.msg import BESTVEL
from novatel_oem7_msgs.msg import INSPVA
import rospy
from std_msgs.msg import String
import actuator
import math
import pid
import time

lat = 0
lng = 0
heading = 0
wp_threshold = 1.111395e5
#GNSS position
def callback_latlong(data):
    global lat,lng
    lat = data.lat
    lng = data.lon

#GNSS heading
def callback_heading(data):

    global heading
    heading=data.azimuth  
rospy.init_node('Navigation', anonymous=True)
#ROS subscription
rospy.Subscriber("/novatel/oem7/bestpos",BESTPOS, callback_latlong)
rospy.Subscriber("/novatel/oem7/inspva",INSPVA, callback_heading)

#TCP connection
obj = actuator.controller("169.254.178.227",5001)
obj.connect()

#PID controller
Kp = 1.65971
Ki = 0.00007
Kd = 0.710
rate_min = -100
rate_max = 100
pid_controller = pid.PIDController(Kp, Ki, Kd, rate_min, rate_max)

def calculate_steer_angle(currentLocation, wp, heading):
    """
    This function takes three inputs:
        - currentLocation: a list of two float values representing the current location
        - wp: a waypoint value
        - heading: a heading value
    It then calculates the steer output based on the current location, waypoint, and heading, and returns the steer output value.
    """
    off_y = - currentLocation[0] + waypoints[wp][0]
    off_x = - currentLocation[1] + waypoints[wp][1]

    # calculate bearing based on position error
    bearing_ppc = 90.00 + math.atan2(-off_y, off_x) * 57.2957795 

    # convert negative bearings to positive by adding 360 degrees
    if bearing_ppc < 0:
        bearing_ppc += 360.00

    # calculate the difference between heading and bearing
    bearing_diff = heading - bearing_ppc

    # normalize bearing difference to range between -180 and 180 degrees
    if bearing_diff < -180:
        bearing_diff = bearing_diff + 360

    if bearing_diff > 180:
        bearing_diff = bearing_diff - 360

    steer_output = 750 * np.arctan(-1 * 2 * 3.5 * np.sin(np.pi * bearing_diff / 180) / 8)
    
    return steer_output

#Load waypoints
def load_waypoints(file_path):
        data_list = []
        try:
            with open(file_path, "r") as file:
                lines = file.readlines()
                for line in lines:
                    # Split each line using a comma as delimiter and convert values to floats
                    values = [float(x.strip()) for x in line.strip().split()]
                    data_list.append(values)
        except FileNotFoundError:
            print("File not found.")
        except Exception as e:
            print(f"Error occurred: {e}")
        return data_list



#file_path = 'output.txt'
#waypoints = load_waypoints(file_path)
waypoints = [[17.602005018136786,78.12680529837355],
[17.602005031904472,78.12680608265849],
[17.60200506083487,78.12680791812626],
[17.602005065022606,78.12680896902637],
[17.60200508026765,78.12681141002795],
[17.60200509147031,78.12681278309803],
[17.602005147991704,78.12681582699153],
[17.602005170518172,78.12681748622013],
[17.602005214211214,78.12682113004036],
[17.602005241895476,78.12682309636664],
[17.60200526285096,78.12682517488633],
[17.602005305486962,78.12682961555261],
[17.602005372241628,78.12683433250454],
[17.60200538756537,78.1268367157273],
[17.602005439246962,78.12684141958962],
[17.602005494551776,78.12684373694553],
[17.602005626028767,78.1268483528234],
[17.60200567206955,78.12685072565493],
[17.602005723213104,78.1268556631973],
[17.60200579352618,78.12685821619431],
[17.602005946876407,78.1268634683557],
[17.60200601711026,78.12686612059764],
[17.60200620736945,78.12687146890171],
[17.60200629047832,78.12687411979877],
[17.602006453477372,78.12687936843223],
[17.602006525208076,78.12688196660892],
[17.60200669208814,78.12688703152358],
[17.60200674817744,78.12688954237555],
[17.60200690029519,78.12689452175782],
[17.602006994247052,78.12689700580816],
[17.602007178921866,78.12690203088592],
[17.602007246485147,78.12690455923428],
[17.60200739989394,78.1269096831019],
[17.602007486407913,78.12691227271267],
[17.60200754999777,78.12691761438472],
[17.602007666983607,78.12692030796138],
[17.602007856480167,78.12692574108195],
[17.60200793159607,78.12692851811585],
[17.602008107473797,78.12693408084844],
[17.60200819401211,78.126936867374],
[17.602008399791522,78.12694237361755],
[17.602008509993563,78.12694507934815],
[17.60200869582945,78.12695038706204],
[17.60200878223074,78.12695299798736],
[17.602008953249165,78.12695805290058],
[17.602009023620393,78.1269605435239],
[17.602009154569053,78.12696538465431],
[17.60200920151579,78.12696773510692],
[17.60200927739945,78.12697231100877],
[17.60200929209349,78.12697452775065],
[17.602009281808222,78.1269788339728],
[17.602009254417002,78.12698096197383],
[17.602009119950367,78.12698505395232],
[17.602009075887853,78.1269870461758],
[17.602008943124428,78.12699098211085],
[17.602008809858507,78.12699298347093],
[17.602008445108414,78.12699693557934],
[17.602008292177697,78.12699890119018],
[17.60200797708311,78.1270029640016],
[17.60200777023109,78.12700497851358],
[17.602007318281704,78.12700896564542],
[17.60200714043666,78.12701091176214],
[17.602006781831978,78.12701477184557],
[17.602006520030677,78.12701666576051],
[17.602005869534363,78.12702047633006],
[17.602005168881572,78.12702424021089],
[17.60200477363524,78.12702610367987],
[17.602003907920565,78.12702991684341],
[17.602003450256074,78.12703184385755],
[17.60200239336063,78.12703559298674],
[17.602001697151433,78.12703748107957],
[17.602000106911444,78.12704121453764],
[17.60199929204327,78.12704308534238],
[17.601997637347843,78.12704677356143],
[17.60199678164667,78.1270485856912],
[17.601994864831955,78.12705205688697],
[17.601993829135182,78.12705369367062],
[17.601991694761754,78.12705677846185],
[17.601990608453015,78.12705828547786],
[17.601988279787523,78.12706107563518],
[17.601987111709665,78.12706247286542],
[17.601984610550844,78.12706523099386],
[17.60198318675868,78.12706662250865],
[17.601980175929295,78.12706929824579],
[17.601978646568323,78.12707058993577],
[17.60197529095802,78.12707303922073],
[17.60197347110414,78.12707419909141],
[17.601969769741807,78.12707639922662],
[17.601967928956824,78.12707753508786],
[17.601963883326906,78.12707930096971],
[17.60196176477712,78.12707994392198],
[17.601957605697105,78.1270812638734],
[17.601955488144874,78.12708188382227],
[17.601951124287492,78.12708280135944],
[17.601948866416155,78.1270831296256],
[17.601944314023914,78.12708369228231],
[17.601941999595578,78.127083904221],
[17.601937263347054,78.12708397628879],
[17.6019348708795,78.12708403437897],
[17.601930025218245,78.12708404618552],
[17.601927544193988,78.12708398368785],
[17.60192257950991,78.12708367580795],
[17.601920004307324,78.12708356115627],
[17.601914736812663,78.12708336124496],
[17.60191203373815,78.127083211174],
[17.601906502778018,78.12708295227125],
[17.601903691480896,78.12708279807636],
[17.6018978688809,78.12708256530551],
[17.601894895798935,78.12708244767789],
[17.601888908018157,78.12708214503628],
[17.60188592459375,78.12708204605501],
[17.601879967054575,78.12708168224088],
[17.601877022932374,78.12708149087247],
[17.601871069024945,78.12708112740874],
[17.60186812569535,78.12708094037677],
[17.601862224643153,78.12708056475705],
[17.60185924801428,78.12708035834967],
[17.601853198567003,78.12707999000199],
[17.601850114042268,78.12707978076224],
[17.601843859635615,78.1270793570948],
[17.60184067555278,78.12707912724778],
[17.601834131828046,78.12707880084703],
[17.601830828124662,78.1270785976519],
[17.60182405527014,78.12707825239706],
[17.60182058512475,78.12707809955786],
[17.60181359204132,78.12707786803804],
[17.6018100957734,78.1270777350236],
[17.60180307530969,78.1270774649102],
[17.60179618505174,78.12707723597546],
[17.601792724052732,78.1270771277128],
[17.601785867784255,78.12707685249562],
[17.60178243368367,78.12707670377104],
[17.60177542512091,78.12707644687222],
[17.601771906920952,78.12707632154135],
[17.601764798342163,78.12707596339001],
[17.601761211107284,78.12707584777102],
[17.60175757198076,78.12707571002257],
[17.60175022496096,78.12707540125189],
[17.601742750656996,78.12707503196053],
[17.601738932272085,78.12707487257498],
[17.60173120883655,78.12707453716915],
[17.601727313097715,78.12707433601324],
[17.6017192518605,78.12707393042409],
[17.601715120451058,78.12707368403103],
[17.601706632828826,78.12707322403872],
[17.60170226443113,78.12707303736588],
[17.60169352099955,78.12707244905145],
[17.60168912681057,78.12707223435095],
[17.601680406064244,78.12707165620469],
[17.60167606042966,78.1270714027879],
[17.6016674829276,78.1270708230381],
[17.60166323666694,78.12707057727111],
[17.601654776129998,78.12706997877541],
[17.6016505414487,78.12706967658244],
[17.60164203336909,78.12706908456636],
[17.601637771133433,78.12706874245393],
[17.60162916558354,78.1270681609774],
[17.60162485351824,78.12706784139831],
[17.601616227710366,78.12706722216697],
[17.601611897824075,78.12706696821184],
[17.601603300714576,78.12706635915839],
[17.6015989466892,78.12706611358321],
[17.601590200585175,78.12706551807602],
[17.60158585360394,78.12706519504478],
[17.601577140986972,78.12706456604243],
[17.60157284993595,78.12706431111765],
[17.60156441030601,78.12706364040889],
[17.601560261119282,78.12706335334163],
[17.60155208175917,78.12706265525074],
[17.60154804303863,78.127062350048],
[17.601540189001508,78.12706165310043],
[17.6015363342788,78.12706132411243],
[17.601528746277555,78.12706048867838],
[17.60152509038412,78.12706008963664],
[17.6015178382502,78.12705946763263],
[17.601514307969058,78.12705908108113],
[17.60150744332701,78.12705820210705],
[17.601504066687102,78.12705774424704],
[17.601497481225778,78.12705693215202],
[17.601494290870797,78.12705644688258],
[17.6014880148284,78.12705537679584],
[17.601484883436548,78.12705478395365],
[17.60147868780324,78.12705344188258],
[17.60147559747903,78.12705267398054],
[17.601469437982804,78.1270510917512],
[17.601466327435205,78.12705027070143],
[17.601460080189902,78.12704833752598],
[17.60145696941606,78.12704729836736],
[17.60145071413538,78.12704497854502],
[17.60144757284105,78.12704380308614],
[17.601441187459972,78.12704127893893],
[17.601434722090996,78.12703848570827],
[17.601431312595526,78.12703710270358],
[17.601424877998312,78.12703379850132],
[17.601421667227346,78.12703206428763],
[17.601415162652543,78.12702839493254],
[17.60141188978087,78.12702645297097],
[17.60140534818985,78.12702230354932],
[17.601402103299673,78.12702002869737],
[17.601395814429672,78.12701519551129],
[17.6013926813409,78.12701275380505],
[17.601386476904057,78.12700766865345],
[17.601383462612585,78.1270051092885],
[17.60137771142744,78.12699961862144],
[17.60137495300774,78.12699689603048],
[17.601369348795444,78.12699127032911],
[17.60136646871217,78.12698856743857],
[17.601361190595657,78.12698252278298],
[17.601358706681825,78.12697936183132],
[17.601353823999442,78.12697297237338],
[17.601351340363223,78.12696980898238],
[17.601346709809015,78.12696314790591],
[17.60134454045643,78.12695971089184],
[17.60134037616188,78.12695275255673],
[17.601338328794004,78.12694925590644],
[17.601334501416233,78.12694196543055],
[17.601332653192067,78.12693835500974],
[17.601329145420273,78.12693103604222],
[17.601327439087694,78.12692734250066],
[17.601324194866443,78.12691982563736],
[17.601322712092724,78.1269160045961],
[17.601319807061536,78.12690831392348],
[17.601318347028855,78.12690449623337],
[17.60131554120411,78.1268968137212],
[17.601314205954967,78.12689293439539],
[17.601311554982328,78.12688514224757],
[17.601310237989036,78.12688129993938],
[17.60130775822763,78.1268736189863],
[17.601306623122053,78.1268697881772],
[17.60130454876214,78.12686212130208],
[17.6013035915075,78.12685827853468],
[17.601301877599877,78.12685064130362],
[17.60130110571147,78.12684676056847],
[17.60129978954342,78.12683906140067],
[17.601299286166725,78.12683519198258],
[17.601298533539595,78.12682736443105],
[17.601298270204296,78.12682344542195],
[17.601298011267918,78.12681567635893],
[17.601298035918777,78.1268117713215],
[17.601298319224075,78.12680407965058],
[17.60129857064777,78.12680028923623],
[17.601299365974164,78.12679284019],
[17.601299884556624,78.12678917981759],
[17.60130112577586,78.12678191101192],
[17.601301839760477,78.12677831604323],
[17.601303448725364,78.12677114930786],
[17.601304347799665,78.12676752593269],
[17.601306437354694,78.12676037358682],
[17.601307605223315,78.12675680967811],
[17.601310151972452,78.12674978583014],
[17.60131145218517,78.12674629741429],
[17.601314370235713,78.12673934619713],
[17.601315945360447,78.12673591945101],
[17.601319317729974,78.12672904842069],
[17.60132105223576,78.12672567178406],
[17.601324705977774,78.12671900530748],
[17.601328555368188,78.12671242714998],
[17.60133057483474,78.12670914795258],
[17.601334835684717,78.12670276496735],
[17.601337044829073,78.12669957807117],
[17.6013415138965,78.12669335620204],
[17.601343835942817,78.12669030670496],
[17.60134624998566,78.12668726131264],
[17.601351342625517,78.12668139347268],
[17.601356694800934,78.1266757236845],
[17.601359422664302,78.12667288079409],
[17.601365016653656,78.12666736293808],
[17.601367946460446,78.12666476738231],
[17.601373879106344,78.12665970485047],
[17.601376872960312,78.12665722222542],
[17.601383062647308,78.12665246796593],
[17.601386207599163,78.12665016658737],
[17.601392581748822,78.1266456868559],
[17.601395835575403,78.12664356202633],
[17.601402451797327,78.1266396034527],
[17.60140582484543,78.12663774839376],
[17.60141270372353,78.12663426672198],
[17.60141620816464,78.12663264449787],
[17.601423467478572,78.1266295757461],
[17.601427072833072,78.12662815895729],
[17.60143451840023,78.12662562442361],
[17.601438290831524,78.12662452413944],
[17.601446024796203,78.12662239196267],
[17.601449919591207,78.12662132581035],
[17.601457737715666,78.12661955366127],
[17.60146174734669,78.1266189057247],
[17.60146975292771,78.12661752633925],
[17.601473820535368,78.12661685481332],
[17.601482192281015,78.12661581829823],
[17.601486403716706,78.12661540018361],
[17.60149496932376,78.12661461580211],
[17.601499253202782,78.12661421921956],
[17.60150801016667,78.12661361245796],
[17.60151245276291,78.12661337359104],
[17.601521420490606,78.12661280361681],
[17.601525947008625,78.12661251466659],
[17.601535108437663,78.12661196949462],
[17.601539807394026,78.12661189141895],
[17.601549144402856,78.12661137651064],
[17.601553878650947,78.12661111862941],
[17.601563411756825,78.12661073498343],
[17.60156825509998,78.12661046448817],
[17.60157794982368,78.12661002036882],
[17.601582842495894,78.1266098218792],
[17.60159267121502,78.12660931387161],
[17.601597613962802,78.1266090883908],
[17.601607541958906,78.12660871957146],
[17.60161252345476,78.12660849821809],
[17.60162250226859,78.12660820213199],
[17.60162752257679,78.12660810436566],
[17.601637553932168,78.1266078719808],
[17.601642580422663,78.12660774907904],
[17.601652657596315,78.12660765203162],
[17.601657696453465,78.12660754329723],
[17.601667827131088,78.12660732360828],
[17.601672886218413,78.12660722486295],
[17.60168301229498,78.12660704722578],
[17.601693022941028,78.12660686853725],
[17.601697990137016,78.12660678022381],
[17.601707768820145,78.12660667668544],
[17.601712599738534,78.12660660849983],
[17.60172207555238,78.12660644417646],
[17.601726720345827,78.12660634511563],
[17.60173583608334,78.12660620827701],
[17.601740280180064,78.12660610631255],
[17.601748953936948,78.12660597133505],
[17.601753193233368,78.12660590690567],
[17.601761499491985,78.12660583024775],
[17.601765623163185,78.12660582582852],
[17.601773885211255,78.1266057274417],
[17.601778012459295,78.1266056541875],
[17.601786302299768,78.12660566083274],
[17.601790490066605,78.12660563199785],
[17.601798896107773,78.12660553867214],
[17.601803141092244,78.12660551233094],
[17.601811687724382,78.12660550062502],
[17.601816002948567,78.12660551710542],
[17.601824763012917,78.12660553343848],
[17.60182915526515,78.12660555612126],
[17.601837897466197,78.12660565796264],
[17.601842195105306,78.12660573999732],
[17.60185070080773,78.12660576847775],
[17.601854873903108,78.12660577506155],
[17.601863073161706,78.12660602472549],
[17.601867107163976,78.12660614770681],
[17.60187503897977,78.12660615466584],
[17.601878875457054,78.12660617002034],
[17.601886393112906,78.12660639317771],
[17.601890044806552,78.1266065620848],
[17.60189714768699,78.1266069425042],
[17.601900623265475,78.12660714488212],
[17.601907357869052,78.12660765521508],
[17.60191065101762,78.1266079934991],
[17.601917040379096,78.1266087521423],
[17.60192014322228,78.12660914703544],
[17.60192617889487,78.12661008858335],
[17.60192907059821,78.12661060065868],
[17.601934669403402,78.12661181480246],
[17.601937384894924,78.12661248624578],
[17.60194259671418,78.12661384741449],
[17.601945112410675,78.1266145802297],
[17.60194995936282,78.1266162254769],
[17.60195228534675,78.12661715115807],
[17.601956818529867,78.12661919340876],
[17.601959043396686,78.12662028805158],
[17.60196338912144,78.12662273983493],
[17.60196552476898,78.12662409555978],
[17.601969652641987,78.12662708595943],
[17.601971643765257,78.12662874649345],
[17.60197552011915,78.1266322267848],
[17.601977391031856,78.12663413508228],
[17.601980879454143,78.12663821343907],
[17.601982465416313,78.12664034180067],
[17.601985465997952,78.12664478122424],
[17.601986883769367,78.1266470786378],
[17.60198944674159,78.12665181932516],
[17.60199059937484,78.12665425379735],
[17.601992625847558,78.1266593354996],
[17.601993609409384,78.12666190120834],
[17.60199539542727,78.12666722976958],
[17.601996112510207,78.12666998073965],
[17.601997409299635,78.12667557675623],
[17.60199798183966,78.12667845217544],
[17.601999030146228,78.12668435663123],
[17.60199950021258,78.1266873425113],
[17.602000210556398,78.12669345700968],
[17.60200080585272,78.12669977769549],
[17.602001081511332,78.12670298767924],
[17.602001376600676,78.12670621703205],
[17.602001856927036,78.12671277307388],
[17.602002357366604,78.12671933990944],
[17.602002634495463,78.12672259955167],
[17.602003215490125,78.1267290076484],
[17.602003496783492,78.12673214851854],
[17.602004040040956,78.12673833025823],
[17.602004295339047,78.12674136159686],
[17.60200481804119,78.12674731029307],
[17.60200507583558,78.12675022658836],
[17.602005562257098,78.1267559297827],
[17.60200579290898,78.12675872455567],
[17.602006251829792,78.126764202872],
[17.60200648976095,78.12676691514913],
[17.602006984573716,78.12677233528025],
[17.602007245539077,78.12677505994999],
[17.602007745712264,78.12678050864668],
[17.602008030214797,78.12678322137204],
[17.602008569482443,78.12678863473917],
[17.602008798587242,78.1267913179372],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725],
[17.60200925001883,78.12679654902725]]
wp = 0
message = "A,N,0,0,0,0,0,0,0,0,0\r\n" 
obj.send_data(message)
feed = obj.receive_data()
print(feed)
message = "A,N,0,1,100,0,0,0,0,0,0\r\n"
obj.send_data(message)
time.sleep(1)
feed = obj.receive_data()
print(feed)
message = "A,D,0,0,0,0,0,0,0,0,0 \r\n"
obj.send_data(message)
feed = obj.receive_data()
print(feed)
while not rospy.is_shutdown():
    try:
        print("waypoint index =============== ",wp)
        position = [float(lat), float(lng)]
        print("Current position = ", position)
        if ((np.linalg.norm(np.array(position) - waypoints[len(waypoints) - 1]) * wp_threshold) > 1):
            steer_angle = calculate_steer_angle(position, wp, heading)
            print("Steer Angle: ",steer_angle)
            steering_feedback = obj.receive_data().split(',')[2]
            print("steer Feedback: ",steering_feedback)
            velocity_feedback= obj.receive_data().split(',')[3]
            print("\nvelocity_feedback: ",velocity_feedback)
            steer_rate = pid_controller.update(steer_angle, float(steering_feedback))
            print("Steer Rate: ",steer_rate)
            if int(velocity_feedback)< 10:
                obj.send_data("A,D,6,0,0,1,"+str(steer_rate)+",0,0,0,0\r\n")
            else:
                obj.send_data("A,D,0,1,30,1,"+str(steer_rate)+",0,0,0,0\r\n")   
            #time.sleep(1)
            if (wp < len(waypoints) and ((np.linalg.norm(np.array(position) - waypoints[wp]) * wp_threshold) < 6)):
                wp = wp + 1
                print("\n Waypoint Number : ",wp)
        else:
            steer_angle = 0
            obj.send_data('A,N,0,1,100,0,0,0,0,0,0\r\r')
            time.sleep(1)
        
        
    except rospy.ROSInterruptException:
        pass
